# Orchestration Enforcement and Validation Rules

## Overview
This document defines the MANDATORY enforcement mechanisms that prevent orchestrator agents from violating the separation of concerns and ensure proper delegation patterns.

## Core Principle: Separation of Concerns

### Agent Types and Their Boundaries

1. **Orchestrator Agents** (mvp-manager, error-fixer)
   - **CAN**: Read files, create documentation IN project/internal/, delegate work
   - **CANNOT**: Write or modify APPLICATION CODE, implement features
   - **TOOLS REMOVED**: Edit, MultiEdit (completely removed)
   - **TOOLS RESTRICTED**: Write (ONLY for project/internal/ and .claude/ paths)
   - **ENFORCEMENT**: Path validation before every Write operation

2. **Planner Agents** (code-architect, interaction-mapper)
   - **CAN**: Analyze, design, document, specify
   - **CANNOT**: Make delegations (they are delegated TO)
   - **ENFORCEMENT**: delegations array must be empty

3. **Doer Agents** (quick-developer)
   - **CAN**: Write code, implement features, modify files
   - **CANNOT**: Delegate work to others
   - **ENFORCEMENT**: Must track who requested their work

## Session Folder Naming Convention (CRITICAL)

### MANDATORY: Global Sequential Numbering

**ALL agents MUST follow this naming convention:**
- Format: `project/internal/DDMM_YYYY_NN/`
- Example: `3108_2025_01/`, `3108_2025_02/`, `3108_2025_03/`

**CRITICAL RULES:**
1. **Sequential Across ALL Agents**: The NN increments globally, not per-agent
2. **NO SUFFIXES ALLOWED**: Never add _error, _mvp, _fix, etc.
3. **Check ALL Existing Folders**: `ls -la project/internal/` to find highest number
4. **Use Next Sequential Number**: If 01, 02 exist, create 03 (regardless of which agent created them)

### IMPORTANT: Rule Embedding Requirement

**These rules MUST be embedded directly in each orchestrator agent's .md file!**

Agents DO NOT read external rule files like this one. Each orchestrator agent that creates session folders MUST have these rules embedded in their own definition file:
- mvp-manager.md ‚úÖ (rules embedded)
- error-fixer.md ‚úÖ (rules embedded)
- Future orchestrators: MUST include session naming rules in their .md files

This file serves as documentation for humans, but agents only follow what's in their own .md files.

**CORRECT Sequence Example:**
- mvp-manager task 1 ‚Üí creates `3108_2025_01/`
- error-fixer task 2 ‚Üí creates `3108_2025_02/` (NOT 3108_2025_01_error!)
- mvp-manager task 3 ‚Üí creates `3108_2025_03/`
- quick-developer standalone ‚Üí creates `3108_2025_04/`
- error-fixer task 5 ‚Üí creates `3108_2025_05/`

**WHY THIS MATTERS:**
- Clean chronological order of ALL work
- Easy to find latest work regardless of agent
- JSON reports inside identify which agent did the work
- No confusion about task sequence

**VIOLATIONS:**
- Creating `3108_2025_01_error/` ‚Üí WRONG! Use `3108_2025_02/`
- Creating `3108_2025_01_mvp/` ‚Üí WRONG! Use clean numbers
- Reusing existing numbers ‚Üí CRITICAL FAILURE
- Skipping numbers ‚Üí Confusing but acceptable if documented

## Validation Rules

### Rule 1: Tool Access Control
Orchestrators have RESTRICTED tool access:
- ‚ùå Edit - COMPLETELY REMOVED (cannot edit any files)
- ‚ùå MultiEdit - COMPLETELY REMOVED (cannot make multiple edits)
- ‚ö†Ô∏è Write - RESTRICTED (ONLY for project/internal/ and .claude/ paths)
- ‚úÖ Read - Can read for analysis
- ‚úÖ Glob/Grep - Can search codebase

**Path Validation for Write Tool**:
```
ALLOWED PATHS:
- project/internal/**/* - Session reports and documentation
- .claude/**/* - Agent configuration (rare)

FORBIDDEN PATHS:
- src/**/* - Application source code
- deploy/**/* - Deployment configurations
- docs/**/* - Project documentation
- *.cs, *.js, *.ts, *.py - Any code files
- appsettings.json, package.json - Configuration files
```

**Validation**: 
- If an orchestrator's tool list includes Edit/MultiEdit, it's misconfigured
- If an orchestrator uses Write outside allowed paths, it's a VIOLATION

### Rule 2: Delegation Tracking
Every orchestrator's JSON report MUST show delegations:

```json
{
  "delegations": [
    {
      "to_agent": "quick-developer",
      "purpose": "Implement feature X",
      "timestamp": "2025-08-31T10:00:00.000Z",
      "status": "completed"
    }
  ]
}
```

**Validation**: If delegations array is empty, orchestrator did work themselves.

### Rule 3: File Attribution
Every file must be traceable to its creator:

**CORRECT Attribution Pattern**:
- Task description by mvp-manager ‚Üí Planning only
- Architecture by code-architect ‚Üí Specification only
- Implementation by quick-developer ‚Üí Actual code

**INCORRECT Attribution Pattern**:
- Implementation by mvp-manager ‚Üí VIOLATION
- Code changes by error-fixer ‚Üí VIOLATION
- Any code file saying "Generated by [orchestrator]" ‚Üí VIOLATION

### Rule 4: Session ID Validation

Every JSON report's session_id MUST match the folder name:
- Folder: `3108_2025_02/`
- session_id: `"3108_2025_02"` (NO SUFFIXES!)

**WRONG:**
```json
{
  "session_id": "3108_2025_01_error",  // ‚ùå NO SUFFIXES!
```

**CORRECT:**
```json
{
  "session_id": "3108_2025_02",  // ‚úÖ Clean sequential number
```

### Rule 5: Session Report Validation

Every session must have a JSON report showing:
1. Which agent did what work
2. Who requested each piece of work
3. Complete audit trail of delegations

**Red Flags in Reports**:
```json
{
  "agent_name": "mvp-manager",
  "files_modified": ["/src/app.js"],  // ‚ùå Orchestrator modified APPLICATION CODE
  "delegations": []  // ‚ùå No delegations means did work themselves
}
```

**VALID Report Pattern**:
```json
{
  "agent_name": "mvp-manager",
  "files_created": [
    "project/internal/3108_2025_01/000-001-session-report.json",  // ‚úÖ Allowed path
    "project/internal/3108_2025_01/001-001-architect-task.md"     // ‚úÖ Allowed path
  ],
  "files_modified": [],  // ‚úÖ No code modifications
  "delegations": [
    {
      "to_agent": "quick-developer",
      "purpose": "Implement feature",
      "files_to_modify": ["/src/app.js"]  // ‚úÖ Developer will modify code
    }
  ]
}
```

## Enforcement Mechanisms

### Mechanism 1: Self-Check Questions
Orchestrators must ask before EVERY action:

1. "Am I about to write or modify code?"
   - If YES ‚Üí STOP and delegate to quick-developer
   - If NO ‚Üí Proceed

2. "Am I implementing something?"
   - If YES ‚Üí STOP and create task for quick-developer
   - If NO ‚Üí Proceed

3. **"Is my Write target under project/internal/ or .claude/?"**
   - If NO ‚Üí STOP IMMEDIATELY and delegate
   - If YES ‚Üí Verify it's a report/documentation file

4. "Have I updated my JSON report?"
   - If NO ‚Üí Update it immediately
   - If YES ‚Üí Continue

### Mechanism 2: Delegation Announcement
Orchestrators MUST announce every delegation:

```
üöÄ Delegating implementation to QUICK-DEVELOPER...
üìÑ Input: implementation-task.md
üìÑ Expected Output: Working code + log
‚è∞ Handoff Time: 2025-08-31T10:00:00.000Z
```

This creates public accountability for proper delegation.

### Mechanism 3: File Signature Enforcement
Every file MUST have clear attribution:

**Documentation Files**:
```markdown
üìã Prepared by [AGENT-NAME] on [TIMESTAMP]
Session: [ID]
Requested by: [who requested this]
```

**Code Files**:
```javascript
// Generated by QUICK-DEVELOPER - [TIMESTAMP]
// Requested by: mvp-manager
// Session: 3108_2025_01
```

### Mechanism 4: Audit Trail Requirements

The `999-002-agent-handoffs.json` file must show complete workflow:

```json
{
  "handoffs": [
    {
      "from": "mvp-manager",
      "to": "code-architect",
      "timestamp": "2025-08-31T09:30:00.000Z",
      "task": "Design architecture"
    },
    {
      "from": "mvp-manager",
      "to": "quick-developer",
      "timestamp": "2025-08-31T10:00:00.000Z",
      "task": "Implement code"
    }
  ],
  "violations": []  // Should be empty
}
```

## Violation Detection

### How to Detect Violations

1. **Check File Signatures**
   ```bash
   grep -r "Generated by MVP-MANAGER" src/
   # Should return NOTHING - orchestrators don't generate code
   ```

2. **Review JSON Reports**
   ```bash
   cat project/internal/*/000-001-session-report.json | grep delegations
   # Should show non-empty delegation arrays for orchestrators
   ```

3. **Audit Implementation Logs**
   ```bash
   grep "Prepared by" project/internal/*/*.md
   # Implementation work should only be by quick-developer
   ```

### Common Violation Patterns

1. **The "Quick Fix" Violation**
   - Orchestrator thinks: "It's just one line..."
   - Makes the change directly
   - VIOLATION: All changes go through quick-developer

2. **The "Urgent" Violation**
   - User says it's urgent
   - Orchestrator skips delegation for speed
   - VIOLATION: Urgency doesn't override process

3. **The "Configuration" Violation**
   - Orchestrator thinks: "It's just config, not code"
   - Tries to Write to appsettings.json or package.json
   - VIOLATION: Configuration files are in forbidden paths

4. **The "Report Location" Violation**
   - Orchestrator creates report in src/ or docs/
   - Uses Write tool outside project/internal/
   - VIOLATION: Reports MUST be in project/internal/

## Corrective Actions

When a violation is detected:

1. **Immediate**: Stop the violating behavior
2. **Document**: Note the violation in session report
3. **Delegate**: Create proper task for appropriate agent
4. **Update**: Fix agent definition to prevent recurrence
5. **Audit**: Check for similar violations in other sessions

## Validation Checklist

Before creating any session folder:
- [ ] Checked ALL existing folders with `ls -la project/internal/`
- [ ] Found highest sequential number across ALL agents
- [ ] Using next sequential number (no gaps unless documented)
- [ ] NO SUFFIX added to folder name
- [ ] JSON report session_id matches folder name exactly

Before closing any orchestrator session:

- [ ] JSON report shows delegations to other agents
- [ ] No code files have orchestrator signatures
- [ ] All implementation work attributed to quick-developer
- [ ] Audit trail shows complete workflow
- [ ] No Edit/MultiEdit operations (tools not available)
- [ ] All Write operations were to project/internal/ or .claude/ ONLY
- [ ] Every delegation was announced
- [ ] Session folder has complete documentation

## Path Validation Examples

### ALLOWED Write Operations:
```bash
# ‚úÖ Creating session report
Write: project/internal/3108_2025_01/000-001-session-report.json

# ‚úÖ Creating task description
Write: project/internal/3108_2025_01/001-001-architect-task.md

# ‚úÖ Updating agent configuration (rare)
Write: .claude/agents/custom-config.md
```

### FORBIDDEN Write Operations:
```bash
# ‚ùå Writing source code
Write: src/components/Button.js  # VIOLATION!

# ‚ùå Writing configuration
Write: appsettings.json  # VIOLATION!

# ‚ùå Writing deployment files
Write: deploy/docker-compose.yml  # VIOLATION!

# ‚ùå Writing documentation
Write: docs/API.md  # VIOLATION!
```

## Emergency Override

There is NO emergency override. The rules apply always:
- Urgent tasks ‚Üí Delegate urgently
- Simple fixes ‚Üí Delegate simple tasks
- Critical bugs ‚Üí Delegate critical fixes
- Need to write code ‚Üí ALWAYS delegate to quick-developer
- Need to write reports ‚Üí ONLY in project/internal/

The orchestration pattern ensures accountability, quality, and maintainability. Breaking it for convenience undermines the entire system.

## Monitoring and Compliance

Regular audits should check:
1. Are orchestrators delegating properly?
2. Are doers tracking who requested their work?
3. Are JSON reports complete and accurate?
4. Are file signatures consistent with agent roles?

Non-compliant agents should be updated immediately to enforce these rules.

## Remember

The strength of the agent system comes from specialization and clear boundaries. When orchestrators do implementation work, they:
- Violate separation of concerns
- Create untraceable work
- Reduce system quality
- Break the audit trail

**Proper orchestration is not optional - it's mandatory.**